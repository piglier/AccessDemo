version: 2.1

orbs:
  ruby: circleci/ruby@2.0.0

jobs:
  build-and-test:
    macos:
      xcode: 16.2.0
    environment:
      FL_OUTPUT_DIR: output
    steps:
      - checkout

      # å®‰è£ Bundlerï¼ˆä»¥å… CI çš„ bundler å¤ªèˆŠï¼‰
      - run:
          name: Install Bundler
          command: gem install bundler

      # ç¦ç”¨ frozen é–å®šï¼Œé¿å… Gemfile.lock å®‰è£éŒ¯èª¤
      - run:
          name: Unfreeze bundler lockfile
          command: bundle config set frozen false

      # å®‰è£ Gem
      - run:
          name: Install Ruby Gems
          command: bundle install

      # ç¹é Swift Macro Plugin é©—è­‰é™åˆ¶
      - run:
          name: Bypass Swift Macro Plugin validation
          command: |
            defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES
            defaults write com.apple.dt.Xcode IDESkipPackagePluginFingerprintValidatation -bool YES

      # åŸ·è¡Œ Fastlane æ¸¬è©¦    
      - run:
          name: Fastlane with keep-alive
          command: |
            while sleep 30; do echo "ğŸŒ€ Running tests..."; done &
            KEEP_ALIVE_PID=$!
            trap "kill $KEEP_ALIVE_PID" EXIT

            bundle exec fastlane test

      - store_artifacts:
          path: output

      - store_test_results:
          path: output/scan

workflows:
  build-test:
    jobs:
      - build-and-test

